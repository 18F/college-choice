version: 2

shared: &shared
  working_directory: ~/repo
  steps:
    - checkout

    # Restore npm modules
    - restore_cache:
        keys:
          - dependency-cache-{{ checksum "package.json" }}

    - run:
        name: NPM Install
        command: npm install

    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
          - node_modules

    - run:
        name: Create directories for xunit reports
        command: |
          mkdir -p ~/reports/mocha
          mkdir -p ~/reports/browser
          mkdir -p ~/reports/a11y

    - run:
        name: Run Mocha unit tests
        command: |
          npm run test-unit-ci
        environment:
          XUNIT_FILE: ~/reports/mocha/unit.xml
        when: always

    # XXX this is a workaround for a bug in WebDriverIO
    # that doesn't allow for absolute paths in the xunit
    # output directory:
    # <https://github.com/webdriverio/webdriverio/issues/926>
    - run:
        name: WebDriverIO workaround directory
        command: |
          ln -s /tmp

    - run:
        name: Wait for Federalist Build
        command: ./test/ci.sh

    - run:
        name: Run Browser tests
        command: npm run test-ci

    - run:
        name: Run A11y tests
        command: npm run test-a11y

    - store_test_results:
        path: ~/reports

jobs:
  test-college-scorecard:
    <<: *shared
    docker:
      - image: circleci/node:4.8


workflows:
  version: 2
  build:
    jobs:
      - test-college-scorecard
